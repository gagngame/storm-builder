name: Build Mule - Windows Squirrel

on:
  workflow_dispatch:
  repository_dispatch:
    types: [build-request]

jobs:
  build:
    runs-on: windows-2025
    strategy:
      matrix:
        include:
          - arch: x64
            qt_version: 6.10.1
          - arch: arm64
            qt_version: 6.10.0
    
    env:
      BUILD_ROOT: ${{ github.workspace }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          cache: true
          set-env: false
          add-tools-to-path: false
          version: ${{ matrix.qt_version }}
          arch: ${{ matrix.arch == 'arm64' && 'win64_msvc2022_arm64_cross_compiled' || 'win64_msvc2022_64' }}

      - name: Build Storm (${{ matrix.arch }})
        shell: cmd
        run: |
          set "PATH=%QT_PATH%;%PATH%"
          scripts\build-arch.bat Release ${{ matrix.arch }}
        env:
          QT_PATH: ${{ github.workspace }}\Qt\${{ matrix.qt_version }}\${{ matrix.arch == 'arm64' && 'msvc2022_arm64' || 'msvc2022_64' }}\bin

      - name: Package with Squirrel (${{ matrix.arch }})
        shell: cmd
        run: |
          cd %BUILD_ROOT%\installer\squirrel
          set "VERSION=dev-%date:~-4,4%%date:~-10,2%%date:~-7,2%"
          if not exist nupkg mkdir nupkg
          if not exist Releases-${{ matrix.arch }} mkdir Releases-${{ matrix.arch }}
          
          if "${{ matrix.arch }}"=="x64" (
            nuget pack Storm.nuspec -BasePath "%BUILD_ROOT%\build\deploy-x64-release" -OutputDirectory nupkg -Version %VERSION%
            if %ERRORLEVEL% neq 0 exit /b 1
            Squirrel.Windows-1.9.1\Squirrel.exe --releasify "nupkg\Storm.%VERSION%.nupkg" --releaseDir "Releases-x64" --no-msi
            if %ERRORLEVEL% neq 0 exit /b 1
          ) else (
            nuget pack Storm-arm64.nuspec -BasePath "%BUILD_ROOT%\build\deploy-arm64-release" -OutputDirectory nupkg -Version %VERSION%
            if %ERRORLEVEL% neq 0 exit /b 1
            Squirrel.Windows-1.9.1\Squirrel.exe --releasify "nupkg\Storm-arm64.%VERSION%.nupkg" --releaseDir "Releases-arm64" --no-msi
            if %ERRORLEVEL% neq 0 exit /b 1
            ren "Releases-arm64\Setup.exe" "Setup-arm64.exe"
          )

      - name: DEBUG - List Squirrel outputs
        shell: cmd
        run: |
          dir /s installer\squirrel\Releases-${{ matrix.arch }}

      - name: Copy to Mule Local Release Directory (${{ matrix.arch }})
        shell: cmd
        run: |
          if not exist D:\mule-releases mkdir D:\mule-releases
          if not exist D:\mule-releases\squirrel-${{ matrix.arch }} mkdir D:\mule-releases\squirrel-${{ matrix.arch }}
          xcopy /Y /S installer\squirrel\Releases-${{ matrix.arch }}\* D:\mule-releases\squirrel-${{ matrix.arch }}\
          echo Squirrel artifacts copied to D:\mule-releases\squirrel-${{ matrix.arch }}\
